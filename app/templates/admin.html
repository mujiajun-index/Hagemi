<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚙️系统设置</title>
    <link rel="stylesheet" href="static/admin.css">
</head>
<body>
    <div class="container">
        <h1>⚙️系统设置</h1>
        <form id="settings-form">
          <div class="category-card">
             <div class="category-header">
                 <span>Gemini API 密钥管理</span>
                 <span class="toggle-icon">▶</span>
             </div>
             <div class="category-content" id="gemini-keys-content">
                 <div style="margin-bottom: 1em; padding: 1em; background-color: #f0f4f8; border-radius: 4px;">
                     <p><strong>功能描述:</strong> 在此管理您的 Gemini API 密钥。系统将使用这些密钥与 Gemini API 进行交互。</p>
                 </div>
                 
                 <!-- 操作按钮区域 -->
                 <div class="keys-controls">
                     <div class="keys-info">
                         <span class="keys-count">总数量: <span id="gemini-keys-count">0</span></span>
                         <span id="gemini-keys-status" class="keys-status"></span>
                     </div>
                     <div class="keys-actions">
                         <button type="button" class="add-btn" onclick="showAddGeminiKeyModal()">+ 添加密钥</button>
                         <button type="button" class="add-btn bulk-action-btn" onclick="showBulkAddGeminiKeysModal()">+ 批量操作</button>
                         <button type="button" class="add-btn bulk-action-btn" onclick="checkAllKeysAvailability()">🔍 批量检查有效性(快速)</button>
                         <button type="button" class="add-btn bulk-action-btn" onclick="checkAllKeysRealValidity()">🧪 批量检查真实有效性</button>
                         <button type="button" class="save-btn" id="save-gemini-keys-btn" onclick="saveGeminiKeysToServer()" style="display: none;">💾 保存更改</button>
                     </div>
                 </div>
                 
                 <table id="gemini-keys-table">
                     <thead>
                         <tr>
                             <th style="width: 10%;">序号</th>
                             <th>API 密钥</th>
                             <th style="width: 20%;">操作</th>
                         </tr>
                     </thead>
                     <tbody>
                         <!-- Gemini Keys will be loaded here -->
                     </tbody>
                 </table>
             </div>
          </div>

          <div class="category-card">
              <div class="category-header">
                  <span>访问密钥管理</span>
                  <span class="toggle-icon">▶</span>
              </div>
              <div class="category-content" id="access-keys-content">
                  <div style="margin-bottom: 1em; padding: 1em; background-color: #f0f4f8; border-radius: 4px;">
                      <p><strong>功能描述:</strong> 在此管理您的访问密钥。这些密钥可用于访问 v1 接口，并可设置次数限制和过期时间。</p>
                  </div>
                  
                  <!-- 操作按钮区域 -->
                  <div class="keys-controls">
                      <div class="keys-info">
                          <span class="keys-count">总数量: <span id="access-keys-count">0</span></span>
                          <span id="access-keys-status" class="keys-status"></span>
                      </div>
                      <div class="keys-actions">
                          <button type="button" class="add-btn" onclick="addAccessKey()">+ 添加新访问密钥</button>
                      </div>
                  </div>
                  
                  <table id="access-keys-table">
                      <thead>
                          <tr>
                              <th style="min-width: 30px;">序号</th>
                              <th>名称</th>
                              <th>密钥</th>
                              <th>使用限制</th>
                              <th>过期时间</th>
                              <th id="status-header" style="cursor: pointer;" onclick="filterAccessKeys()">状态❇️</th>
                              <th style="min-width: 60px;">每日重置</th>
                              <th style="min-width: 60px;">操作<span onclick="loadAccessKeys();alert('刷新成功！')" style="cursor: pointer;">🔄</span></th>
                          </tr>
                      </thead>
                      <tbody>
                          <!-- Access Keys will be loaded here -->
                      </tbody>
                  </table>
              </div>
          </div>

          <div class="category-card">
              <div class="category-header">
                  <span>代理路由映射</span>
                  <span class="toggle-icon">▶</span>
              </div>
              <div class="category-content" id="api-mappings-content">
                  <div style="margin-bottom: 1em; padding: 1em; background-color: #f0f4f8; border-radius: 4px;">
                      <p><strong>功能描述:</strong> 此功能允许您将特定的 API 请求前缀代理到不同的目标地址。例如，您可以将所有发往 <code>/openai</code> 的请求转发到 <code>https://api.openai.com</code>。</p>
                      <p><strong>使用示例:</strong> 直接访问本项目地址 <code>http://localhost:7860/openai/v1/chat/completions</code> 即可将请求代理到 <code>https://api.openai.com/v1/chat/completions</code></p>
                  </div>
                  <table id="api-mappings-table">
                      <thead>
                          <tr>
                              <th style="width: 10%;">序号</th>
                              <th>请求前缀</th>
                              <th>目标地址</th>
                              <th style="width: 20%;">操作</th>
                          </tr>
                      </thead>
                      <tbody>
                          <!-- Mappings will be loaded here -->
                      </tbody>
                  </table>
                  <button type="button" class="add-btn" onclick="addApiMapping()">+ 添加新映射</button>
              </div>
          </div>

          <div class="category-card">
              <div class="category-header">
                  <span>历史文件查看</span>
                  <span class="toggle-icon">▶</span>
              </div>
              <div class="category-content" id="media-gallery-content">
                   <div id="storage-details-container" style="margin-bottom: 1.5em; display: none;">
                       <div class="progress-bar-container">
                           <div id="image-count-progress" class="progress-bar"></div>
                       </div>
                       <p id="image-count-text" class="progress-text"></p>
                       <div class="progress-bar-container">
                           <div id="image-size-progress" class="progress-bar"></div>
                       </div>
                       <p id="image-size-text" class="progress-text"></p>
                   </div>
                  <div class="gallery-controls">
                      <div class="radio-group" id="storage-type-selector">
                          <label class="radio-label">
                              <input type="radio" name="storageType" value="local" checked> 本地
                          </label>
                          <label class="radio-label">
                              <input type="radio" name="storageType" value="memory"> 内存
                          </label>
                      </div>
                      <div class="gallery-actions">
                          <button type="button" class="add-btn" id="select-all-media-btn">全选</button>
                          <button type="button" class="add-btn delete-btn" id="delete-selected-media-btn">删除选中</button>
                      </div>
                  </div>
                  <div id="media-loader">正在加载文件...</div>
                  <div class="media-grid" id="media-grid-container">
                      <!-- Media will be loaded here -->
                  </div>
                  <div class="pagination-controls" id="pagination-container">
                      <!-- Pagination will be loaded here -->
                  </div>
              </div>
          </div>

          <div class="category-card">
              <div class="category-header">
                  <span>系统工具</span>
                  <span class="toggle-icon">▶</span>
              </div>
              <div class="category-content">
                  <a href="/logs" target="_blank" class="tool-button">
                    <span class="tool-button-icon">ℹ️</span>
                    <span>查看实时日志</span>
                  </a>
              </div>
          </div>

          <div class="button-group">
                <button type="button" class="logout-btn" onclick="logout()">退出登录</button>
          </div>
        </form>
    </div>
   <div id="modal" class="modal">
       <div class="modal-content">
           <div class="modal-header">
               <h2 id="modal-title"></h2>
               <span class="modal-close">&times;</span>
           </div>
           <div class="modal-body">
               <p id="modal-text" style="margin-top: 0;"></p>
               <div id="modal-single-input-container">
                   <input type="text" id="modal-input" class="modal-input">
               </div>
               <div id="modal-textarea-container" style="display: none;">
                   <label for="modal-textarea" style="display:block; font-weight: bold;">请输入密钥（每行一个）:</label>
                   <textarea id="modal-textarea" class="modal-textarea" rows="8" placeholder="密钥1&#10;密钥2&#10;密钥3"></textarea>
                   <p style="font-size: 0.85em; color: #666; margin-top: 0.5em;">支持回车分割，每行一个密钥</p>
                   <div class="modal-switch-container" id="bulk-delete-switch-container" style="display: none;">
                       <span>批量删除模式</span>
                       <label class="switch">
                           <input type="checkbox" id="bulk-delete-mode-switch">
                           <span class="slider"></span>
                       </label>
                   </div>
               </div>
               <div id="modal-mapping-container" style="display: none;">
                   <label for="modal-input-prefix" style="display:block; font-weight: bold;">请求前缀</label>
                   <input type="text" id="modal-input-prefix" class="modal-input" placeholder="/example">
                   <label for="modal-input-target" style="display:block; margin-top:1em; font-weight: bold;">目标地址</label>
                   <input type="text" id="modal-input-target" class="modal-input" placeholder="https://api.example.com">
               </div>
               <div id="modal-access-key-container" style="display: none;">
                   <label for="modal-input-name" style="display:block; font-weight: bold;">名称</label>
                   <input type="text" id="modal-input-name" class="modal-input" placeholder="例如, 'My Test Key'">
                   
                   <label for="modal-input-usage-limit" style="display:block; margin-top:1em; font-weight: bold;">使用限制(次)</label>
                   <input type="number" id="modal-input-usage-limit" class="modal-input" placeholder="留空表示无限制">

                   <label for="modal-input-expires-at" style="display:block; margin-top:1em; font-weight: bold;">过期时间 (小时)</label>
                   <input type="number" id="modal-input-expires-at" class="modal-input" placeholder="输入小时数, 留空表示永不过期">

                   <div id="modal-is-active-container" class="modal-switch-container" style="display: none;">
                        <span>是否启用</span>
                        <label class="switch">
                            <input type="checkbox" id="modal-input-is-active">
                            <span class="slider"></span>
                        </label>
                    </div>

                   <div id="modal-reset-daily-container" class="modal-switch-container" style="display: none;">
                        <span>每日重置使用次数</span>
                        <label class="switch">
                            <input type="checkbox" id="modal-input-reset-daily">
                            <span class="slider"></span>
                        </label>
                    </div>
               </div>
           </div>
           <div class="modal-footer">
               <button id="modal-cancel-btn" class="modal-btn modal-btn-cancel">取消</button>
               <button id="modal-confirm-btn" class="modal-btn modal-btn-confirm">确认</button>
           </div>
       </div>
   </div>

    <!-- Media Viewer Modal -->
    <div id="media-viewer-modal" class="modal">
        <span class="modal-close" id="media-viewer-close">&times;</span>
        <div class="modal-content" id="media-viewer-content">
            <!-- Content (image or video) will be injected here -->
        </div>
        <a class="prev">&#10094;</a>
        <a class="next">&#10095;</a>
    </div>

    <!-- Loading Spinner -->
    <div id="loader" class="loader-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>
</body>
<script src="static/admin.js"></script>
</html>